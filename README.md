
実施する場面
・試験
・運用

必要となる事前情報
・ネットワーク構成図
・端末のネットワーク設定(端末のIPアドレス、ホスト名、DNS/メールサーバのIPアドレス)

captureツール
・wireshark
・tcp dump(wiresharkにインポート可)
・microsoft message analyzer(wiresharkにインポート可)

captureを実施する端末とは別の端末のpacketをcaptureしたい場合
・リピーターハブ
-> 受け取ったパケットのコピーを転送するネットワーク機器
・ミラーポート
->指定したポートでやり取りしているパケットを別のポートにリアルタイムにコピーするスイッチの機能

captureを実施する端末と、packetをcaptureする端末の時刻を合わせる
packetをcaptureする端末のキャッシュをクリアする


wireshark
・パケット一覧
・パケット詳細
・パケットバイト列

入力オプション
・プロミスキャス
->NICの動作モード、受け取ったパケットを全て取り込んで処理する、全てがいらない場合はオフにする
・キャプチャフィルタ

出力オプション
ファイルの分割、世代管理などで効率化

キャプチャフィルタ
プロトコル名　ディレクション　タイプ　値

表示フィルタ
フィールド名　リレーション　値

パケット詳細の項目を右クリックでパケット一覧の列として追加可能
ファイルのエクスポート、結合可能

プロトコル階層統計
どのプロトコルのパケットがどのくらい流れているかを階層的に確認可能

対話解析
どの端末とどの端末がどれくらい通信しているか、通信の組み合わせをプロトコルごとに表にまとめる
->通信帯域を大量消費している通信の組み合わせや、ユーザーがよくアクセスするサイトを見つけ出すのに便利

終端解析
どの端末がどのくらい通信しているか、プロトコルごとに表にまとめる

パケット長解析
どのくらいのサイズのパケットが、どれくらいネットワークを流れているかをまとめる
->端末やネットワーク機器側でパケットを加工しているが、その処理結果を見れる

入出力グラフ
キャプチャデータに含まれる値を、時間に基づいてグラフ化する

OSI参照モデル
物理層
データと信号を相互に変換
送信側で、変換時に符号化を実施
受信側でも多少のエラーは訂正できる
複雑なエラーはデータリンク層で修正

データリンク層
データ全体の整合性をチェックして、物理層では訂正しきれないエラーを検知、データの信頼性を担保
有線LANはEthernet
無線LANはIEEE802.11

EthernetのフレームフォーマットはほぼEhternet IIでOK
以下の5つのフィールドで構成
1.プリアンプル
->これからEthernetフレームを送る、という合図を意味する64ビットパターン
　受信側から見て、Wiresharkでキャプチャするより前に取り外されてしまうので、Wiresharkではキャプチャ不可
2.宛先/送信元MACアドレス
->Ethernetに接続されている端末を表す48ビットの識別ID
->1,2を合わせて、Ethernetヘッダー
3.タイプ
->ネットワーク層でどんなプロトコルを使用しているか(IPv4,ARP等)を表す16ビットの識別ID
4.Ethernetペイロード
-> 上位層のデータそのものを意味する、IPだったらIPパケット、ARPならARPフレーム
->サイズは46バイトから1500バイトまで、46バイトに満たなければパディングでダミーデータを入れる、1500バイトを超える場合は上位層で分割する
->パディングは送信側から見て、wiresharkでキャプチャするより後に付与されるので、送信側から見ると付与されていないように、受信側から見ると付与されて見える
->Ethernetフレームに入る データの最大サイズのことをMTU(Maximun Transmission Unit)
5.FCS(Frame Check Sequence)
->Ethernetペイロードが壊れていないかをチェックする32ビットのフィールド
->受信側から見て、Wiresharkでキャプチャした後に付与され、送信側から見て、Wiresharkでキャプチャする前に取り外されてしまうので、Wiresharkではキャプチャ不可

MACアドレス

・I/G(Indivisual/Group)ビット
先頭から8ビット目にあり、MACアドレスが1:1通信のためのユニキャストアドレスか、1:n通信のためのマルチキャストアドレスかを示している
0なら各端末に個別に割り当てられているユニキャストアドレスを、1なら複数の端末のグループに割り当てられているマルチキャストアドレスを意味する
**同じEthernet上にある全ての端末を表すブロードキャストアドレスは、全てのビットが1のff:ff:ff:ff:ff:ffという特別なMACアドレスが割り当てられていて、マルチキャストアドレスの一種として扱われる

・U/L(Unique/Local)ビット
先頭から7ビット目にあり、MACアドレスがグローバルアドレスかローカルアドレスかを示している
0ならグローバルアドレス、1ならローカルアドレス

・OUI(Organizationally Unique Identifier)
グローバルMACアドレスの上位24ビット、ベンダーコードを意味する

・UAA(Universal Administrated Address)
グローバルMACアドレスの下位24ビット、NICに割り当てたシリアルコードを意味する

MACアドレスは3種類
・ユニキャスト
・マルチキャスト
・ブロードキャスト

レイヤー2スイッチ
Ethernetヘッダーに含まれている送信元MACアドレスと自分自身のポート番号を管理する(MACアドレステーブル)ことで、Ethernetフレームの転送先を切り替え(L2スイッチング)、通信の効率化を図っている

フラッティング
宛先がどのポートに接続されているか不明のため、L2スイッチが送信元ポートを除く全てのポートにEthernetフレームを転送すること

VLAN(Virtual Local Area Network)
1台のL2スイッチを仮想的に複数台のように見せる技術

ポートVLAN
1ポートに1つのVLANを割り当てる
ポートにVLAN IDという識別子を設定し、MACアドレステーブルにもVLAN ID込みで登録する

タグVLAN
EthernetフレームにVLAN情報をVLANタグとして付与する
1つのポート、ケーブルに複数のVLANのフレームを流せるようにする

IEEE802.1q
VLANタグを付与したフレームのフォーマット
Ethernetの送信元MACアドレスとタイプの間に、TPID(Tag Protocol Identifier)とTCI(Tag Control Information)を差し込む
TCIはPCP(Priority Code Point)、CFI(Canotical Format Identifier)、VIDから構成される

ブリッジングループ
Ethernetフレームが複数のリンクを伝ってぐるぐる回ること
WiresharkではARPのパケットで埋め尽くされる

PPPoE(Point to Point Protocol over Ethernet)
PPPをEthernetネットワーク上で使用できるように拡張したレイヤー2プロトコル

PPP
1:1の通信に特化、LCP(Link Control Protocol)とNCP(Network Control Protocol)で構成

PPPの認証
PAP(Password Authentication Protocol)かCHAP(Challenge Handshake Authentication Protocol)を使用

PPPoE
Ethernet上でPPPを使用するために、ディスカバリーステージとPPPセッションステージを踏む

ARP(Address Resolution Protocol)
レイヤー2のMACアドレスと、レイヤー3のIPアドレスを紐づけるプロトコル
データを送信したいとき、送信元MACアドレスはわかるが、宛先MACアドレスは分からないので、宛先IPから宛先MACアドレスを求める
IPアドレスの重複検知や、冗長構成時におけるMACアドレステーブルの更新機能も担う

IPのパケットフォーマット
以下で構成
1.バージョン
2.ヘッダー長
3.ToS(Type of Service)
8ビットで構成、先頭3ビットをIPプレシデンス、先頭6ビットをDSCP(Diffserv Code Point)
ルータごとの転送設定(PHB:Per Hop Behavior)と、それに合わせた基本のDSCP名と値が決められている
EF(Expedited Forwarding),AF(Assured Forwarding),CS(Class Selector),デフォルトがある
4.パケット長
5.識別子
フラグメンテーションに関連、IPペイロードがMTUに収まらない場合に使用
6.フラグ
7.フラグメントオフセット
8.TTL
9.プロトコル番号
10.ヘッダーチェックサム
11.送信元/宛先IPアドレス

IPアドレス
ネットワーク部とホスト部で構成
サブネットマスクで分割される
サブネットマスクは10進法表記とCIDR表記
255.255.255.0=/24

IPアドレスはクラスA~Eまで
グローバルIPとプライベートIP
プライベートIP->グローバルIPの接続には、NAT(Network Address Translation)を使用

端末には設定できないアドレス
ネットワークアドレス
ホスト部のビットが全て0のアドレス、ネットワークそのものを表す
192.168.1.1に255.255.255.0なら、192.168.1.0
デフォルトルートアドレス
IPアドレス、サブネットマスク共に全て0、全てのネットワークを表す
ブロードキャストアドレス
ホスト部のビットが全て1のIPアドレス、そのネットワークにある全ての端末を表す
192.168.1.1に255.255.255.0なら、192.168.1.255
ループバックアドレス
第一オクテットが127のIPアドレス、自分自身を表す

Reassemble franmented IPv4 datagrams
フラグメントされたIPパケットを自動的に再構築して表示する機能

Validate the IPv4 checksum if possible
IPヘッダーチェックサムの機能が値が正しいかチェックする機能

L3スイッチ
異なるEthernetを繋ぎ、IPパケットを転送する
ルータは宛先ネットワークと、IPパケットを転送するべき隣接機器のIPアドレスであるネクストホップを管理する

デフォルトゲートウェイ
デフォルトルートのネクストホップのこと

ルーティングテーブルの検索->ARPテーブルの検索、の順に進む

ルーティングループ
ルートの設定間違えを原因で生じる

IPsec(Security Architecture for Internet Protocol)
ネットワーク層でIPパケットのカプセル化や認証、暗号化を実施し、インターネット上に仮想的な専用線を作る技術
以下の3つのプロトコルを組み合わせる
1.ISAKMP(Internet Security Association Key Management Protocol)
2.ESP(Encapulating Security Payload)
3.AH(Authenticatin Header)

SA(Security Association)
IPsecによって作られる仮想的な専用線のこと
フェーズ1でISAKMPを使用して認証、暗号の共有を実施
フェーズ2で制御用のISAKMP SAを作成
その後IPsec SA(上り用)、IPsec SA(下り用)でデータを通信

IPsecSAのカプセル化モードにはトンネルモードとトランスポートモードがある
プロトコルにはESPとAHがある

ICMP(Internet Control Messge Protocol)
レイヤー3プロトコルの1種
IPレベルの通信を確認したり、エラーを通知したりする(pingもこれの1種)

ICMPのフィールド
重要なのはタイプとフィールド
タイプはEcho Reply, Destination Unreachable, Redirect, Echo Request, TTL超過等

トラブルシュートはping(ICMPのEcho Request)から
Echo Requestが返ってくる->トランスポート層(UDP, TCP)、アプリケーション層(HTTP, SSL, DNS)と上位層に向かって疎通を確認する
Echo Requestが返ってこない->ネットワーク層(IP)、データリンク層(Ethernet, ARP)->物理層(ケーブル、物理ポート)と下位層に向かって疎通を確認する

Echo Reply
1.Destination Unreachable(タイプ3)
-> IPパケットを宛先IPアドレスの端末までルーティングできなかったとき
1-1.Network Unreachable(タイプ3/コード0) 
->ルーティングテーブルにルーティングエントリーがない場合
1-2.Host Unreachable(タイプ3/コード1)
->ルーティングエントリーはあるが、ネクストホップが動作していない場合
1-3.Fragmentation needed but DF bit set(タイプ3/コード4)
->入口のインターフェースのMTUより出口のインターフェースのMTUが小さく、フラグメントが必要にも関わらず、DFビットが1になっていてフラグメントができない場合
1-4.Communication administratively prihibited by filtering(タイプ3/コード13)
->ルータやファイヤフォールのフィルタリングによって、パケットが拒否された場合

2.Redirect(タイプ5)
送信元端末に対して、適切なゲートウェイアドレスを通知する

3.TTL Exceeded(タイプ11/コード0)
送信元端末に対して、TTLが0になってIPパケットを破棄したことを通知する


UDP(User Datagram Protocol)
即時性を求めるアプリケーションで使用
IPヘッダーのプロトコル番号は17

UDPのパケットフォーマット
・送信元/宛先ポート番号
・UDPデータグラム長
・チェックサム

ポート番号は3種類
1.System Ports
2.User Ports
->宛先ポート番号に使用、サーバアプリケーションの識別に使用
->UDPの123ならNTP、53ならDNS
3.Dynamic and/or Private Ports
->送信元ポート番号に使用、クライアントアプリケーションの識別に使用
->ランダムに割り当てて、どのアプリケーションに応答を返せば良いか分かるようにする

ソケット
IPアドレスとポート番号の組み合わせのこと

ファイヤウォール
トランスポート層で動作する機器

ステートフルインスペクション
FWの通信制御機能のこと
フィルタリングルールとコネクションテーブルから構成
フィルタリングルールをコネクションの情報を元に動的に書き換えることでセキュリティ強度を高めている
フィルタリングルールの許可に合致した場合、コネクションテーブルにコネクションエントリを追加し、同時にコネクションエントリに対応する戻り通信を許可するフィルタリングルールを動的に追加する
拒否に合致した場合は、コネクションテーブルにコネクションエントリを追加せず、クライアントにDestination UnreachableのICMPパケットを返す
Dropに合致した場合は、ICMPパケットも返さない
通信が終了したら、コネクションエントリのアイドルタイムをカウントアップし、アイドルタイムが超過したら、コネクションエントリとそれに関連するフィルタリングルールを削除する


TCP(Transmission Control Protocol)
データ送受信前にTCPコネクションを作り、送信パイプと受信パイプを作成する
IPヘッダーのプロトコル番号は6

TCPのパケットフォーマット
1.送信元/宛先ポート番号
2.シーケンス番号
->TCPセグメントを正しい順序に並び替えるために使用
3.確認応答番号(ACK番号)
->次はここからのデータをくれ、と相手に通知するためのフィールド
4.データオフセット
->TCPヘッダーの長さを表す
5.コントロールビット
->コネクションの状態を制御する、緊急フラグ、確認応答フラグなど
6.ウィンドウサイズ
->受信ウィンドウを送信元端末に通知する領域、確認応答を待たずに受け取り切れるデータサイズ
・送信バッファ
すでに送信したが確認応答が返ってきていない領域と、送信する準備はできているがまだ送信していない領域に分けられる
・受信バッファ
確認応答を返したがまだアプリケーションに渡せていない領域と、空き領域で構成
7.チェックサム
8.緊急ポインタ
9.オプション

TCPコネクション
1.接続開始フェーズ
->3ウェイハンドシェイクでコネクションをオープンにする
->必ずクライアント側から始まり、SYN->SYN/ACK->ACKの順番でフラグをやりとりする
2.接続確立フェーズ
->フロー制御、輻輳(ふくそう)制御、再送制御
3.接続終了フェーズ
->4ウェイハンドシェイクでコネクションを終了する
->FIN/ACK->ACK->FIN/ACK->ACKの順番でフラグをやりとりする 

MSS(Maximun Segment Size)
TCPセグメントに詰め込むことができるアプリケーションデータの最大サイズ
MTUから40バイトを引いたもの
MSSにIPヘッダーとTCPヘッダーを足すとMTUになる

SACK(Selective Acknowledgment)

TFO(TCP Fast Open)
本来であればアプリケーションデータを乗せない3ウェイハンドシェイクのSYN SYN/ACKにデータを乗せる

Nagleアルゴリズム
遅延ACK
Early Transmit
Tail Loss Probe

HTTP(Hyper Text Tranfer Protocol)
・HTTP/1.1
パイプライン、キープアライブ等の機能が追加
・HTTP/2.0
マルチプレキシング、サーバプッシュ等の機能が追加
暗号化通信が必須

HTTPメッセージ
1.リクエストメッセージ
2.レスポンスメッセージ

どちらも
・スタートライン
・メッセージヘッダー
・メッセージボディー
で構成

1.リクエストメッセージ
・リクエストライン
メソッド、リクエストURI、HTTPバージョン






ネットワーク層
トランスポート層
アプリケーション層

